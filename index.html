<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copiloto Legal: Comparador Legislativo Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for Word export -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- Library for Diff viewer -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #resultsTable th, #resultsTable td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
        }
        #resultsTable th {
            background-color: #f2f2f2;
            text-align: left;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ins {
            background-color: #d4edda;
            text-decoration: none;
        }
        del {
            background-color: #f8d7da;
            text-decoration: line-through;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        .modal-button {
            margin-top: 1.5rem;
            padding: 0.5rem 1.5rem;
            border-radius: 0.375rem;
            background-color: #2563eb;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <div class="container mx-auto p-4 md:p-8 flex-grow">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Copiloto Legal</h1>
            <p class="text-gray-600 mt-2">Su asistente para la generación de indicaciones y tablas comparativas de textos legales.</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <label for="apiKey" class="block text-lg font-semibold mb-2">Your Gemini API Key</label>
            <input type="password" id="apiKey" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Paste your API key here to enable the tool">
            <p class="text-sm text-gray-500 mt-2">Su clave se utiliza únicamente en su navegador y nunca se almacena.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Texto Original Completo</h2>
                <textarea id="originalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition" placeholder="Pegue aquí la columna completa del texto original..."></textarea>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Texto Final Completo</h2>
                <textarea id="finalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition" placeholder="Pegue aquí la columna completa del texto final modificado..."></textarea>
            </div>
        </div>

        <div class="text-center my-8">
            <button id="generateButton" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Generar Tabla Comparativa
            </button>
        </div>

        <div id="outputSection" class="bg-white p-6 rounded-lg shadow-md hidden">
             <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-semibold">Resultado Comparativo <span id="timerResult" class="text-sm font-normal text-gray-500 ml-2"></span></h2>
                  <button id="exportButton" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Exportar a Word
                  </button>
             </div>
             <div id="resultsContainer" class="w-full overflow-x-auto">
                 <!-- The results table will be rendered here -->
             </div>
        </div>
    </div>

    <footer class="text-center p-4 text-gray-500 text-sm">
        <p>Copiloto Legal v4.0.9 | Última actualización: 19 de Agosto, 2025</p>
    </footer>

    <!-- Modal for custom alerts -->
    <div id="customAlert" class="modal-backdrop hidden">
        <div class="modal-content">
            <p id="alertMessage"></p>
            <button id="alertCloseButton" class="modal-button">Cerrar</button>
        </div>
    </div>

    <script>
        document.getElementById('generateButton').addEventListener('click', generateIndications);
        document.getElementById('exportButton').addEventListener('click', exportToWord);
        document.getElementById('alertCloseButton').addEventListener('click', () => {
            document.getElementById('customAlert').classList.add('hidden');
        });

        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('customAlert').classList.remove('hidden');
        }

        function cleanTextForJson(text) {
            let cleaned = text.trim();
            if (cleaned.startsWith('```json')) {
                cleaned = cleaned.substring(7);
            } else if (cleaned.startsWith('```')) {
                 cleaned = cleaned.substring(3);
            }
            if (cleaned.endsWith('```')) {
                cleaned = cleaned.slice(0, -3);
            }
            cleaned = cleaned.replace(/,(?=\s*[}\]])/g, ''); 
            return cleaned.trim();
        }
        
        function renderTable(articles) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = ''; 

            if (!articles || articles.length === 0) {
                container.textContent = 'No se encontraron artículos o no se pudo procesar el texto.';
                return;
            }

            const table = document.createElement('table');
            table.id = 'resultsTable';
            table.className = 'w-full border-collapse';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th class="w-1/3 p-2 border bg-gray-100">Texto Original (con cambios)</th>
                    <th class="w-1/3 p-2 border bg-gray-100">Indicaciones Generadas</th>
                    <th class="w-1/3 p-2 border bg-gray-100">Texto Final (con cambios)</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            articles.forEach(article => {
                const diff = Diff.diffWords(article.textoOriginal || '', article.textoFinal || '', { ignoreWhitespace: true });
                let originalHtml = '';
                let finalHtml = '';

                diff.forEach(part => {
                    const value = part.value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    if (part.added) {
                        finalHtml += `<ins>${value}</ins>`;
                    } else if (part.removed) {
                        originalHtml += `<del>${value}</del>`;
                    } else {
                        originalHtml += value;
                        finalHtml += value;
                    }
                });
                
                const indicationsText = article.indicaciones || '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 border align-top whitespace-pre-wrap">${originalHtml}</td>
                    <td class="p-2 border align-top whitespace-pre-wrap">${indicationsText.replace(/\n/g, '<br>')}</td>
                    <td class="p-2 border align-top whitespace-pre-wrap">${finalHtml}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            container.appendChild(table);

            document.getElementById('outputSection').classList.remove('hidden');
        }

        async function generateIndications() {
            const apiKey = document.getElementById('apiKey').value;
            const originalText = document.getElementById('originalText').value;
            const finalText = document.getElementById('finalText').value;
            const resultsContainer = document.getElementById('resultsContainer');
            const outputSection = document.getElementById('outputSection');
            const generateButton = document.getElementById('generateButton');
            const timerResult = document.getElementById('timerResult');
            
            if (!apiKey) {
                showAlert('Por favor, ingrese su clave de API de Gemini para continuar.');
                return;
            }
            
            if (!originalText.trim() || !finalText.trim()) {
                showAlert('Por favor, pegue el texto en ambas columnas para generar las indicaciones.');
                return;
            }

            generateButton.disabled = true;
            generateButton.textContent = 'Generando...';
            outputSection.classList.remove('hidden');
            resultsContainer.innerHTML = '<div class="loader"></div>';
            timerResult.textContent = ''; 

            const startTime = performance.now(); 

            /**
             * PROMPT UPDATE v4.0.9
             * The prompt's core logic has been rewritten to be more robust. It now explicitly
             * differentiates between suppression, replacement, and reordering by analyzing both
             * what happened to the original article's content and where the final article's content came from.
             * A final cleanup instruction was also added to remove formatting artifacts.
             */
            const prompt = `
**Rol y Objetivo:**
Eres un asesor legal experto, especializado en la redacción de leyes en Chile. Tu tarea es analizar dos versiones de un texto legal ('Texto Original' y 'Texto Final') y generar una **"Propuesta de Indicaciones"** precisa y con formato correcto, manejando correctamente el reordenamiento y reemplazo de artículos.

---

**1. TAREA PRINCIPAL: LISTA ÚNICA Y CONSECUTIVA**
Tu objetivo es producir una sola lista de indicaciones para todo el documento. La numeración DEBE ser continua a lo largo de todos los artículos.

---

**2. INSTRUCCIONES DE FORMATO DE SALIDA (JSON OBLIGATORIO Y VÁLIDO)**
Tu respuesta DEBE ser un único objeto JSON válido.
- **REGLA DE ESCAPE CRÍTICA:** Dentro de los valores de cadena de texto de JSON, cualquier comilla doble (") DEBE ser escapada con una barra invertida (\\"). Todos los saltos de línea DEBEN ser representados como \`\\n\`.
- El JSON debe contener una clave "articulos" cuyo valor es un array de objetos con las claves: \`textoOriginal\`, \`indicaciones\`, \`textoFinal\`.
- Para artículos sin cambios, el valor de \`indicaciones\` DEBE ser una cadena vacía ("").

---

**3. METODOLOGÍA DE ANÁLISIS GLOBAL Y JERÁRQUICO (PROCESO OBLIGATORIO)**
Aplica este proceso para cada artículo en orden:

**PASO 1: ANÁLISIS DE CAMBIOS ESTRUCTURALES MAYORES**
Realiza este análisis ANTES de buscar cambios pequeños. Para cada artículo, determina cuál de las siguientes situaciones aplica.

- **A. REORDENAMIENTO:** ¿El contenido del "Artículo 7 Original" es casi idéntico al del "Artículo 6 Final"?
  - **SI:** La indicación para el Artículo 6 es: \`Para reemplazar el artículo 6° por el actual artículo 7°, con las siguientes modificaciones: [detallar cambios si los hay].\` La indicación para el Artículo 7 sería \`Para suprimir el artículo 7°.\` y se detiene el análisis para el Art. 7.

- **B. REEMPLAZO (CRÍTICO):** Si no hay reordenamiento, ¿el contenido del "Artículo 7 Final" es completamente NUEVO y diferente al "Artículo 7 Original"?
  - **SI:** La indicación es: \`Para reemplazar el artículo 7° por el siguiente: "[Texto nuevo completo del Artículo 7 Final]".\` Si se cumple esta condición, detén el análisis para este artículo y pasa al siguiente. **Esta regla tiene prioridad sobre la supresión si hay contenido nuevo.**

- **C. SUPRESIÓN:** Si A y B no aplican, ¿el "Artículo 7 Final" está vacío o ha sido eliminado?
  - **SI:** La indicación es: \`Para suprimir el artículo 7°.\` Si se cumple esta condición, detén el análisis para este artículo y pasa al siguiente.

**PASO 2: ANÁLISIS DE CONTENIDO DETALLADO (SI NO HAY CAMBIOS ESTRUCTURALES)**
Si ninguno de los casos del PASO 1 aplica, procede con el análisis de contenido:

- **NIVEL 1 - CAMBIO MÍNIMO:** ¿El cambio es una sola palabra, un número o una frase corta? **Esta es la opción preferida.**
  - **Ejemplo:** \`Para reemplazar, en su inciso primero, el vocablo "treinta" por "sesenta".\`

- **NIVEL 2 - MÚLTIPLES CAMBIOS EN UN INCISO:** ¿Hay varios cambios pequeños en el MISMO inciso?
  - **Ejemplo:** \`AL ARTÍCULO X\\n1.- Para modificar su inciso tercero en el siguiente sentido:\\ni. Suprímase la expresión "no podrá exceder".\\nii. Intercálase la frase "anual".\`

- **NIVEL 3 - REESCRITURA COMPLETA (ÚLTIMO RECURSO):** ¿El inciso ha sido reescrito tan extensamente que los cambios pequeños no pueden describirse?
  - **Ejemplo:** \`Para sustituir su inciso final por el siguiente: "[Texto nuevo completo]".\`

---

**4. REGLAS CRÍTICAS DE REDACCIÓN Y NUMERACIÓN**
- **NUMERACIÓN CONSECUTIVA:** Mantén un contador único para las indicaciones (1.-, 2.-, 3.-) a lo largo de TODO el documento.
- **CONTEXTO:** Especifica siempre el 'inciso', 'numeral' o 'literal' afectado.
- **LIMPIEZA FINAL (OBLIGATORIO):** Antes de finalizar, revisa el texto de todas las indicaciones generadas. Asegúrate de que no contengan artefactos de formato como \\" al inicio o final del texto citado. El texto debe ser limpio y profesional. Por ejemplo, cambia \`\\"frase\\"\` a \`"frase"\`.

---

**5. ANÁLISIS DE TEXTOS**
Procesa el documento completo. Incluye TODOS los artículos en el array JSON, incluso si no tienen cambios.

**Texto Original:**
\`\`\`
${originalText}
\`\`\`

**Texto Final:**
\`\`\`
${finalText}
\`\`\`

---

Ahora, genera la "Propuesta de Indicaciones" aplicando rigurosamente el proceso de análisis para lograr la máxima precisión y un JSON perfectamente válido.
`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            let jsonTextForDebugging = '';
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`La solicitud a la API falló con el estado ${response.status}: ${errorBody}`);
                }

                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                jsonTextForDebugging = jsonText;

                if (!jsonText) {
                    throw new Error('La respuesta de la API no contiene texto procesable.');
                }
                
                const cleanedJson = cleanTextForJson(jsonText);
                const data = JSON.parse(cleanedJson);
                
                renderTable(data.articulos);

                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                timerResult.textContent = `(Generado en ${duration} segundos)`;

            } catch (error) {
                console.error('Error al procesar la solicitud:', error);
                
                let userMessage = `Ocurrió un error al generar las indicaciones. Error: ${error.message}`;

                if (error instanceof SyntaxError && error.message.includes('JSON')) {
                    userMessage = 'Error: La respuesta del modelo no era un JSON válido. Esto puede deberse a comillas dobles (") sin escapar o comas adicionales en el texto original. Por favor, intente de nuevo.';
                    console.error("TEXTO JSON INVÁLIDO RECIBIDO:", jsonTextForDebugging);
                }

                resultsContainer.innerHTML = `<p class="text-red-500">${userMessage}</p>`;
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generar Tabla Comparativa';
            }
        }

        function exportToWord() {
            const table = document.getElementById('resultsTable');
            if (!table) {
                showAlert("No hay resultados para exportar.");
                return;
            }
            
            const tableClone = table.cloneNode(true);
            
            tableClone.querySelectorAll('br').forEach(br => br.parentNode.replaceChild(document.createTextNode('\n'), br));

            const content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid black; padding: 8px; text-align: left; vertical-align: top; white-space: pre-wrap; }
                        th { background-color: #f2f2f2; }
                        ins { background-color: #d4edda; text-decoration: none; color: black; }
                        del { background-color: #f8d7da; text-decoration: line-through; color: black; }
                    </style>
                </head>
                <body>
                    <h1>Tabla Comparativa de Indicaciones</h1>
                    ${tableClone.outerHTML}
                </body>
                </html>
            `;
            
            var converted = htmlDocx.asBlob(content);
            saveAs(converted, 'Tabla_Comparativa_Indicaciones.docx');
        }
    </script>
</body>
</html>
