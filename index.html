<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copiloto Legal: Comparador Legislativo Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #resultsTable th, #resultsTable td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: top;
        }
        #resultsTable th {
            background-color: #f2f2f2;
            text-align: left;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ins {
            background-color: #d4edda;
            text-decoration: none;
        }
        del {
            background-color: #f8d7da;
            text-decoration: line-through;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 400px;
        }
        .modal-button {
            margin-top: 1.5rem;
            padding: 0.5rem 1.5rem;
            border-radius: 0.375rem;
            background-color: #2563eb;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">

    <div class="container mx-auto p-4 md:p-8 flex-grow">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Copiloto Legal</h1>
            <p class="text-gray-600 mt-2">Su asistente para la generación de indicaciones y tablas comparativas de textos legales.</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <label for="apiKey" class="block text-lg font-semibold mb-2">Your Gemini API Key</label>
            <input type="password" id="apiKey" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Paste your API key here to enable the tool">
            <p class="text-sm text-gray-500 mt-2">Su clave se utiliza únicamente en su navegador y nunca se almacena.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Texto Original Completo</h2>
                <textarea id="originalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition" placeholder="Pegue aquí la columna completa del texto original..."></textarea>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Texto Final Completo</h2>
                <textarea id="finalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 transition" placeholder="Pegue aquí la columna completa del texto final modificado..."></textarea>
            </div>
        </div>

        <div class="text-center my-8">
            <button id="generateButton" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Generar Tabla Comparativa
            </button>
        </div>

        <div id="outputSection" class="bg-white p-6 rounded-lg shadow-md hidden">
             <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-semibold">Resultado Comparativo <span id="timerResult" class="text-sm font-normal text-gray-500 ml-2"></span></h2>
                  <button id="exportButton" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        Exportar a Word
                  </button>
             </div>
             <div id="resultsContainer" class="w-full overflow-x-auto">
                 </div>
        </div>
    </div>

    <footer class="text-center p-4 text-gray-500 text-sm">
        <p>Copiloto Legal v4.1.0 | Última actualización: 19 de Agosto, 2025</p>
    </footer>

    <div id="customAlert" class="modal-backdrop hidden">
        <div class="modal-content">
            <p id="alertMessage"></p>
            <button id="alertCloseButton" class="modal-button">Cerrar</button>
        </div>
    </div>

    <script>
        document.getElementById('generateButton').addEventListener('click', generateIndications);
        document.getElementById('exportButton').addEventListener('click', exportToWord);
        document.getElementById('alertCloseButton').addEventListener('click', () => {
            document.getElementById('customAlert').classList.add('hidden');
        });

        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('customAlert').classList.remove('hidden');
        }

        function cleanTextForJson(text) {
            let cleaned = text.trim();
            if (cleaned.startsWith('```json')) {
                cleaned = cleaned.substring(7);
            } else if (cleaned.startsWith('```')) {
                 cleaned = cleaned.substring(3);
            }
            if (cleaned.endsWith('```')) {
                cleaned = cleaned.slice(0, -3);
            }
            cleaned = cleaned.replace(/,(?=\s*[}\]])/g, ''); 
            return cleaned.trim();
        }
        
        function renderTable(articles) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = ''; 

            if (!articles || articles.length === 0) {
                container.textContent = 'No se encontraron artículos o no se pudo procesar el texto.';
                return;
            }

            const table = document.createElement('table');
            table.id = 'resultsTable';
            table.className = 'w-full border-collapse';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th class="w-1/3 p-2 border bg-gray-100">Texto Original (con cambios)</th>
                    <th class="w-1/3 p-2 border bg-gray-100">Indicaciones Generadas</th>
                    <th class="w-1/3 p-2 border bg-gray-100">Texto Final (con cambios)</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            articles.forEach(article => {
                const diff = Diff.diffWords(article.textoOriginal || '', article.textoFinal || '', { ignoreWhitespace: true });
                let originalHtml = '';
                let finalHtml = '';

                diff.forEach(part => {
                    const value = part.value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    if (part.added) {
                        finalHtml += `<ins>${value}</ins>`;
                    } else if (part.removed) {
                        originalHtml += `<del>${value}</del>`;
                    } else {
                        originalHtml += value;
                        finalHtml += value;
                    }
                });
                
                const indicationsText = article.indicaciones || '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2 border align-top whitespace-pre-wrap">${originalHtml}</td>
                    <td class="p-2 border align-top whitespace-pre-wrap">${indicationsText.replace(/\n/g, '<br>')}</td>
                    <td class="p-2 border align-top whitespace-pre-wrap">${finalHtml}</td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            container.appendChild(table);

            document.getElementById('outputSection').classList.remove('hidden');
        }

        async function generateIndications() {
            const apiKey = document.getElementById('apiKey').value;
            const originalText = document.getElementById('originalText').value;
            const finalText = document.getElementById('finalText').value;
            const resultsContainer = document.getElementById('resultsContainer');
            const outputSection = document.getElementById('outputSection');
            const generateButton = document.getElementById('generateButton');
            const timerResult = document.getElementById('timerResult');
            
            if (!apiKey) {
                showAlert('Por favor, ingrese su clave de API de Gemini para continuar.');
                return;
            }
            
            if (!originalText.trim() || !finalText.trim()) {
                showAlert('Por favor, pegue el texto en ambas columnas para generar las indicaciones.');
                return;
            }

            generateButton.disabled = true;
            generateButton.textContent = 'Generando...';
            outputSection.classList.remove('hidden');
            resultsContainer.innerHTML = '<div class="loader"></div>';
            timerResult.textContent = ''; 

            const startTime = performance.now(); 

            /**
             * PROMPT UPDATE v4.1.0
             * This prompt introduces a strict, hierarchical analysis process.
             * 1.  **Article Segmentation:** It first forces the model to identify and isolate each article.
             * 2.  **Hierarchical Logic:** It then applies a clear decision tree for each article (no change, suppression, total replacement) before attempting a detailed analysis.
             * 3.  **Precise Terminology:** It provides clear templates for adding/removing specific elements like 'incisos' and 'literales', resolving the core issue from the previous version.
             * 4.  **Worked Example:** A concrete example based on the user's problematic case is included to guide the model to the correct output format and logic.
             */
            const prompt = `
**Rol y Objetivo:**
Eres un asesor legislativo experto en técnica parlamentaria chilena. Tu misión es analizar dos versiones de un texto legal ("Texto Original" y "Texto Final") y generar un conjunto de "indicaciones" (enmiendas) que transformen el original en el final. Tu respuesta debe ser un objeto JSON VÁLIDO y preciso.

---
**Formato de Salida Obligatorio: JSON**
La salida DEBE ser un único objeto JSON. Dentro de los valores de cadena del JSON, las comillas dobles (") deben escaparse como \\" y los saltos de línea como \\n. El objeto debe tener una clave "articulos" que contenga un array de objetos, cada uno con las claves: \`textoOriginal\`, \`indicaciones\` y \`textoFinal\`.

---
**Proceso de Análisis Estricto (Seguir en Orden):**

**PASO 1: SEGMENTACIÓN DE ARTÍCULOS**
- Antes de comparar, divide mentalmente tanto el "Texto Original" como el "Texto Final" en sus artículos constituyentes (Artículo 1°, Artículo 2°, etc.). Todo el análisis posterior se hará artículo por artículo.

**PASO 2: COMPARACIÓN POR ARTÍCULO Y GENERACIÓN DE INDICACIONES**
- Itera a través de cada artículo del "Texto Original" y compáralo con su contraparte en el "Texto Final".
- Mantén un **contador único y consecutivo** para las indicaciones (1.-, 2.-, 3.-) a lo largo de todo el documento.

**Jerarquía de Reglas para Generar Indicaciones (aplicar en este orden de prioridad):**

1.  **SIN CAMBIOS:** Si el Artículo X° original y final son idénticos, el campo \`indicaciones\` para ese artículo debe ser una cadena vacía (\`""\`).

2.  **SUPRESIÓN (Eliminación):**
    - **De un Artículo Completo:** Si el Artículo X° existe en el original pero no en el final, la indicación es: \`Para suprimir el artículo X°.\`
    - **De una Parte Interna (Inciso/Párrafo, Numeral, Literal):** Si se elimina un párrafo completo dentro de un artículo, la indicación es: \`Para suprimir el [inciso/párrafo] [segundo/tercero/etc.] del artículo X°.\` o \`Para suprimir el literal X) del artículo Y°.\`.

3.  **ADICIÓN (Agregado):**
    - **De un Artículo Completo:** Si el Artículo X° no existe en el original pero sí en el final, la indicación es: \`Para agregar el siguiente artículo X°, nuevo: "[Texto completo del nuevo artículo]"\`.
    - **De una Parte Interna:** Si se agrega una nueva parte, la indicación es: \`Para agregar, en el artículo X°, el siguiente [inciso/literal] [letra/número], nuevo: "[Texto completo de la nueva parte]"\`.

4.  **SUSTITUCIÓN / REEMPLAZO:**
    - **De un Artículo Completo:** Si el Artículo X° es reescrito por completo, la indicación es: \`Para reemplazar el artículo X° por el siguiente: "[Texto completo del artículo final]"\`. Usa esta opción si el cambio es muy extenso.
    - **De una Parte Interna:** \`Para sustituir el [inciso/literal] [contexto] por el siguiente: "[Texto nuevo de la parte]"\`.

5.  **MODIFICACIÓN SIMPLE (Último Recurso):** Solo si ninguna de las reglas anteriores aplica, describe el cambio más pequeño posible.
    - **Ejemplo:** \`Para reemplazar, en el inciso primero del artículo X°, la palabra "antiguo" por "nuevo".\`

---
**Ejemplo Práctico para Guiar tu Lógica:**

* **Texto Original:**
    \`\`\`
    Artículo 1.- ... (párrafo 1) ...
    ... (párrafo 2) ...
    La prestación de los servicios señalados quedará sometida a la fiscalización de la Comisión para el Mercado Financiero.

    Artículo 2.- ...
    a) Plataformas de financiamiento colectivo.
    b) Sistemas alternativos de transacción.
    c) Asesoría crediticia y de inversión.
    \`\`\`
* **Texto Final:**
    \`\`\`
    Artículo 1.- ... (párrafo 1) ...
    ... (párrafo 2) ...

    Artículo 2.- ...
    a) Plataformas de financiamiento colectivo.
    b) Sistemas alternativos de transacción.
    c) Asesoría crediticia y de inversión.
    d) Custodia de instrumentos financieros u otros instrumentos públicos.
    \`\`\`
* **Indicaciones Correctas Esperadas:**
    - Para el Artículo 1°: \`1.- Para suprimir el párrafo tercero del artículo 1°.\`
    - Para el Artículo 2°: \`2.- Para agregar, en el artículo 2°, el siguiente literal d), nuevo:\\nd) Custodia de instrumentos financieros u otros instrumentos públicos.\`

---
**Textos a Procesar:**
Incluye TODOS los artículos en el JSON, incluso aquellos sin cambios. Ahora, aplica este riguroso proceso a los siguientes textos:

**Texto Original:**
\`\`\`
${originalText}
\`\`\`

**Texto Final:**
\`\`\`
${finalText}
\`\`\`
`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            let jsonTextForDebugging = '';
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`La solicitud a la API falló con el estado ${response.status}: ${errorBody}`);
                }

                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                jsonTextForDebugging = jsonText;

                if (!jsonText) {
                    throw new Error('La respuesta de la API no contiene texto procesable.');
                }
                
                const cleanedJson = cleanTextForJson(jsonText);
                const data = JSON.parse(cleanedJson);
                
                renderTable(data.articulos);

                const endTime = performance.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                timerResult.textContent = `(Generado en ${duration} segundos)`;

            } catch (error) {
                console.error('Error al procesar la solicitud:', error);
                
                let userMessage = `Ocurrió un error al generar las indicaciones. Error: ${error.message}`;

                if (error instanceof SyntaxError && error.message.includes('JSON')) {
                    userMessage = 'Error: La respuesta del modelo no era un JSON válido. Esto puede deberse a comillas dobles (") sin escapar o comas adicionales en el texto original. Por favor, intente de nuevo.';
                    console.error("TEXTO JSON INVÁLIDO RECIBIDO:", jsonTextForDebugging);
                }

                resultsContainer.innerHTML = `<p class="text-red-500">${userMessage}</p>`;
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generar Tabla Comparativa';
            }
        }

        function exportToWord() {
            const table = document.getElementById('resultsTable');
            if (!table) {
                showAlert("No hay resultados para exportar.");
                return;
            }
            
            const tableClone = table.cloneNode(true);
            
            // Replace <br> with newlines for better Word formatting
            tableClone.querySelectorAll('br').forEach(br => br.parentNode.replaceChild(document.createTextNode('\n'), br));

            const content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Times New Roman', Times, serif; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid black; padding: 8px; text-align: left; vertical-align: top; white-space: pre-wrap; }
                        th { background-color: #f2f2f2; }
                        ins { background-color: #d4edda; text-decoration: none; color: black; }
                        del { background-color: #f8d7da; text-decoration: line-through; color: black; }
                    </style>
                </head>
                <body>
                    <h1>Tabla Comparativa de Indicaciones</h1>
                    ${tableClone.outerHTML}
                </body>
                </html>
            `;
            
            var converted = htmlDocx.asBlob(content);
            saveAs(converted, 'Tabla_Comparativa_Indicaciones.docx');
        }
    </script>
</body>
</html>
